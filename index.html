<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NyayaSetu - Digital Justice Portal</title>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6VjeJJ1-JhUozW3QUZR9vu9bx16Nyrws",
      authDomain: "nyayasetu-a9621.firebaseapp.com",
      projectId: "nyayasetu-a9621",
      storageBucket: "nyayasetu-a9621.appspot.com",
      messagingSenderId: "411412684697",
      appId: "1:411412684697:web:581935616e789c81df3d08",
      measurementId: "G-0J6C3BCDCM"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    async function uploadEvidence(event) {
      event.preventDefault();

      const name = document.getElementById("name").value.trim();
      const gender = document.querySelector('input[name="gender"]:checked')?.value || "Not specified";
      const description = document.getElementById("desc").value.trim();
      const fileInput = document.getElementById("file");
      const file = fileInput.files[0];

      if (!description) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ò‡§ü‡§®‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç‡•§ (Please fill the incident description.)");
        return;
      }

      if (!file) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§ (Please upload a file.)");
        return;
      }

      const maxFileSize = 50 * 1024 * 1024; // 50MB
      if (file.size > maxFileSize) {
        alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§°‡§º‡•Ä ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ 50MB ‡§∏‡•á ‡§ï‡§Æ ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§ (File too large. Please upload less than 50MB.)");
        return;
      }

      try {
        const submitBtn = document.querySelector("#evidenceForm button[type='submit']");
        submitBtn.disabled = true;
        submitBtn.textContent = "‚è≥ Uploading evidence... 0%";

        // Create file reference
        const fileRef = ref(storage, 'evidence/' + Date.now() + '_' + file.name);
        const uploadTask = uploadBytesResumable(fileRef, file);

        // Track progress
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            submitBtn.textContent = `‚è≥ Uploading evidence... ${progress}%`;
          },
          (error) => {
            console.error("Upload error:", error);
            alert("‚ùå ‡§ï‡•Å‡§õ ‡§ó‡§≤‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§ (Something went wrong, please try again.)");
            submitBtn.disabled = false;
            submitBtn.textContent = "üì§ ‡§∏‡§¨‡•Ç‡§§ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç (Submit Evidence)";
          },
          async () => {
            // Upload complete
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

            // Save metadata + URL in Firestore
            await addDoc(collection(db, "nyayasetu"), {
              name: name || "Anonymous",
              gender: gender,
              description: description,
              fileName: file.name,
              fileUrl: downloadURL,
              timestamp: serverTimestamp()
            });

            document.getElementById("evidenceForm").reset();
            alert("‚úÖ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡§¨‡•Ç‡§§ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! (Your evidence has been successfully uploaded!)");
            submitBtn.disabled = false;
            submitBtn.textContent = "üì§ ‡§∏‡§¨‡•Ç‡§§ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç (Submit Evidence)";
          }
        );

      } catch (error) {
        console.error("Upload error:", error);
        alert("‚ùå ‡§ï‡•Å‡§õ ‡§ó‡§≤‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§ (Something went wrong, please try again.)");
        const submitBtn = document.querySelector("#evidenceForm button[type='submit']");
        submitBtn.disabled = false;
        submitBtn.textContent = "üì§ ‡§∏‡§¨‡•Ç‡§§ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç (Submit Evidence)";
      }
    }

    async function submitDoubt(event) {
      event.preventDefault();

      const name = document.getElementById('accusedName').value.trim();
      const reason = document.getElementById('doubtReason').value.trim();

      const url = 'https://ulxidtauuoeudbddxsuj.supabase.co/rest/v1/doubts';
      const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVseGlkdGF1dW9ldWRiZGR4c3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxNzI0MTYsImV4cCI6MjA2NTc0ODQxNn0.vPEYUUdGSBB-s1ehTE7LyQfKqxFwBM6hGUEMiFf-WNg';

      if (!reason) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§Ç‡§¶‡•á‡§π ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç‡•§ (Please fill the doubt reason.)");
        return;
      }

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'apikey': apiKey,
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            accused_name: name || "Anonymous",
            doubt_reason: reason
          })
        });

        if (response.ok) {
          alert("‚úÖ Your report has been submitted.");
          document.getElementById('doubtForm').reset();
        } else {
          alert("‚ùå Error submitting report. Please try again.");
        }
      } catch (error) {
        console.error("Error submitting doubt:", error);
        alert("‚ùå Error submitting report. Please try again.");
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById("evidenceForm").addEventListener("submit", uploadEvidence);
      document.getElementById("doubtForm").addEventListener("submit", submitDoubt);
    });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      background-color: #f9f9f9;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5em;
    }
    label {
      font-weight: bold;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.2em;
      margin-bottom: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    .gender-group {
      margin-bottom: 1em;
    }
    .gender-group label {
      font-weight: normal;
      margin-right: 1em;
    }
    input[type="file"] {
      margin-bottom: 1.5em;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 0.7em 1.2em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      margin-bottom: 2em;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    hr {
      margin: 2em 0;
      border: none;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>üìú NyayaSetu - Digital Justice Portal</h1>

  <form id="evidenceForm" novalidate>
    <label for="name">‡§®‡§æ‡§Æ (Optional):</label><br />
    <input type="text" id="name" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (Optional)" autocomplete="off" /><br />
    <div class="gender-group">
      <label>‡§≤‡§ø‡§Ç‡§ó (Gender):</label><br />
      <label><input type="radio" name="gender" value="Male" /> ‡§™‡•Å‡§∞‡•Å‡§∑ (Male)</label>
      <label><input type="radio" name="gender" value="Female" /> ‡§Æ‡§π‡§ø‡§≤‡§æ (Female)</label>
      <label><input type="radio" name="gender" value="Other" /> ‡§Ö‡§®‡•ç‡§Ø (Other)</label>
      <label><input type="radio" name="gender" value="Prefer not to say" checked /> ‡§ï‡§π‡§®‡§æ ‡§™‡§∏‡§Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ (Prefer not to say)</label>
    </div>

    <label for="desc">‡§ò‡§ü‡§®‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ (Incident Description):</label><br />
    <textarea id="desc" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§ò‡§ü‡§®‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." required></textarea><br />

    <label for="file">‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (Photo/Video/Audio):</label><br />
    <input type="file" id="file" accept="image/*,video/*,audio/*" required /><br />

    <button type="submit">üì§ ‡§∏‡§¨‡•Ç‡§§ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç (Submit Evidence)</button>
  </form>

  <hr />

  <h2>‡§∂‡§Ç‡§ï‡§æ / ‡§∏‡§Ç‡§¶‡•á‡§π ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (Submit Doubt / Report)</h2>

  <form id="doubtForm" novalidate>
    <label for="accusedName">‡§Ü‡§∞‡•ã‡§™‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ (Accused Name):</label><br />
    <input type="text" id="accusedName" placeholder="‡§Ü‡§∞‡•ã‡§™‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (Optional)" autocomplete="off" /><br />

    <label for="doubtReason">‡§∂‡§Ç‡§ï‡§æ / ‡§∏‡§Ç‡§¶‡•á‡§π ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ (Reason for Doubt):</label><br />
    <textarea id="doubtReason" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§∂‡§Ç‡§ï‡§æ ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." required></textarea><br />

    <button type="submit">üö® ‡§∏‡§Ç‡§¶‡•á‡§π ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç (Submit Doubt)</button>
  </form>

</body>
</html>
